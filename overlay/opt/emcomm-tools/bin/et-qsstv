#!/usr/bin/env bash
#
# Author: Clifton Jones
# Description:
#  EmComm Tools wrapper for QSSTV
#

QSSTV_CONF_TEMPLATE="${ET_HOME}/conf/template.d/qsstv_9.0.conf"
QSSTV_CONF="${HOME}/.config/ON4QZ/qsstv_9.0.conf"

usage() {
  echo "usage: $(basename $0) <command>"
  echo "  <command>"
  echo "    start           - Start QSSTV"
  echo "    update-config   - Update configuration for selected mode"
}

if [ $# -ne 1 ]; then
  usage
  exit 1
fi

notify_user() {
  notify-send \
   -t 5000 \
   --app-name="EmComm Tools" \
   "$1"
}

update-config () {
    [ -z "$ET_USER_CONFIG" ] && ET_USER_CONFIG="${HOME}/.config/emcomm-tools/user.json"

    CALLSIGN=$(cat ${ET_USER_CONFIG} | jq -r .callsign)
    GRID=$(cat ${ET_USER_CONFIG} | jq -r .grid)

    if [ "${CALLSIGN}" = "N0CALL" ]; then
      notify_user "Can't start QSSTV. No callsign set. Run: et-user."
      exit 1
    fi

    et-log "Updating QSSTV config file: ${QSSTV_CONF}..."
    mkdir -p $(dirname ${QSSTV_CONF})
    cp -v ${QSSTV_CONF_TEMPLATE} ${QSSTV_CONF}
    sed -i "s|{{ET_CALLSIGN}}|${CALLSIGN}|g" ${QSSTV_CONF}
    sed -i "s|{{ET_GRID}}|${GRID}|g" ${QSSTV_CONF}
    sed -i "s|{{ET_USER_HOME}}|${HOME}|g" ${QSSTV_CONF}


    # 1. Check if the symlink was created by the udev rules
    if [ -e /dev/et-audio ]; then

       # 2. Check that this device was properly tagged with the ET_AUDIO env variable with a udev rule
       APLAY_OUT=$(arecord -l | grep ET_AUDIO)
       if [ $? -eq 0 ]; then
         AUDIO_DEVICE=$(echo $APLAY_OUT | cut -d"," -f2 | cut -d":" -f1 | awk '{print $2}')

         QSSTV_AUDIO_DEVICE="hw:CARD=ET_AUDIO,DEV=${AUDIO_DEVICE} -- USB Audio CODEC, USB Audio"
  
         et-log "Using '${QSSTV_AUDIO_DEVICE}' for QSSTV configuration."

         # 3. Check for existing QSSTV sound configuration

         ## Update input
         grep "^inputAudioDevice" ${QSSTV_CONF}
         if [ $? -eq 0 ]; then
           sed -i "s|^inputAudioDevice.*|inputAudioDevice=\"${QSSTV_AUDIO_DEVICE}\"|" ${QSSTV_CONF} 
         else
           echo "inputAudioDevice=\"${QSSTV_AUDIO_DEVICE}\"" >> ${QSSTV_CONF}
         fi

         ## Update output
         grep "^outputAudioDevice=" ${QSSTV_CONF}
         if [ $? -eq 0 ]; then
           sed -i "s|^outputAudioDevice.*|outputAudioDevice=\"${QSSTV_AUDIO_DEVICE}\"|" ${QSSTV_CONF} 
         else
           echo "outputAudioDevice=\"${QSSTV_AUDIO_DEVICE}\"" >> ${QSSTV_CONF}
         fi

         ## Configure ALSA settings for sound card
         /opt/emcomm-tools/bin/et-audio update-config

       else
         et-log "No ET_AUDIO device detected."
         notify_user "Can't start QSSTV. No ET_AUDIO device detected."
         exit 1
       fi
    else
      et-log "No ET_AUDIO device plugged in."
      notify_user "Can't start QSSTV. No supported audio device plugged in."
      exit 1
    fi

    echo "Generated the configuration below..."
    echo
    cat ${QSSTV_CONF}
    echo

}

start() {
  /opt/emcomm-tools/bin/et-kill-all && update-config && /usr/local/bin/qsstv &
}

case $1 in
  start)
    start
    ;;
  update-config)
    update-config
    ;;
  *)
    echo "Invalid command."
    usage
    exit 1
  ;;
esac





